# MultiLogViewer アプリケーション仕様書

## 1. 目的

複数の異なる形式のログファイルを一元的に読み込み、統一されたビューで閲覧・分析することを目的とします。

## 2. 主要機能

### 2.1 パスの解決 (プレースホルダー対応)

- **概要**: `log_file_patterns` に日時を表すプレースホルダーを使用可能にし、実行時の日時に応じて動的にファイルパスを解決します。
- **サポートするプレースホルダー**:
  - `{yyyy}`: 西暦 4 桁
  - `{yy}`: 西暦 2 桁
  - `{MM}`: 月
  - `{dd}`: 日
  - `{HH}`: 時
  - `{mm}`: 分
- **動作仕様**:
  - `FileResolver` は検索実行時のシステム時刻（または指定された時刻）を使用してプレースホルダーを置換した後に glob パターンによる検索を行います。
  - Tail 機能（リアルタイム監視）が有効な場合、ポーリングごとにパスを再評価します。これにより、日付を跨いだ際に新しい日付のディレクトリやファイルが自動的に監視対象に追加されます。

### 2.2 ログフォーマット設定

**方法**

YAML 形式の設定ファイルを用いて、ログファイルのフォーマットと対象ファイルを定義します。

**内容**

- **対象ファイル**: `log_file_patterns` に、このフォーマットを適用するログファイルの glob パターンをリスト形式で指定します。
- **パースルール**:
  - ログ 1 行全体に適用するプライマリな正規表現（`pattern`）を定義します。
  - 抽出する項目には名前を付け（例: `timestamp`, `level`, `message`）、`LogEntry`オブジェクトに格納します。
    - `timestamp`と`message`は基本的な項目として扱われますが、それ以外（`level`を含む）は`AdditionalData`に格納されます。
  - 特定のフィールド（例: `message`）の内容をさらにパースするため、追加の正規表現（`sub_patterns`）を定義できます。

**例**

```yaml
log_formats:
  - name: "ApplicationLog"
    log_file_patterns:
      - "C:\\Logs\\App\\*.log"
      - "C:\\Logs\\Old\\app-*.log"
    pattern: "^(?<timestamp>\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}) \\\\[(?<level>\\w+)\\] (?<message>.*)$"
    timestamp_format: "yyyy-MM-dd HH:mm:ss"
    sub_patterns:
      - source_field: "message"
        pattern: "User '(?<user>\\w+)' from (?<ip>[\\d\\.]+)"
```

### 2.3 ログの読み込みとパース

**読み込みトリガー**

アプリケーション起動時に、設定ファイルに基づきログの読み込みを自動的に開始します。手動でのファイル選択機能は廃止します。

**処理フロー**

1. 各`log_format`定義内の`log_file_patterns`（glob パターン）を`FileResolver`サービスが解決し、一致するすべてのログファイルパスのリストを取得します。
2. 該当するログファイルを一行ずつ読み込みます。
   - 1 つのファイルに対して複数のフォーマット（`log_formats`）が該当する場合、定義された順序でパターンマッチングを試行します。
   - 最初にマッチしたフォーマット定義にしたがって、構造化されたデータ（ログエントリ）に変換します。
3. `LogFileReader`は、各ログエントリがどのファイルの何行目から読み込まれたかという情報も付与します。
4. すべてのフォーマット・ファイルから集約したログエントリをビューに表示します。

**LogEntry オブジェクトの構造**

各ログエントリは、以下の情報を持つオブジェクトとして表現されます。

- `Timestamp` (DateTime): ログのタイムスタンプ
- `Message` (string): ログメッセージ
- `FileName` (string): ログの発生元ファイル名
- `LineNumber` (int): ログの発生元ファイルにおける行番号
- `AdditionalData` (Dictionary<string, string>): `level`など、正規表現で抽出されたその他のデータ

### 2.4 時刻によるソート

- パースされたログエントリは、日時情報に基づいて昇順または降順でソートされます。
- 異なるフォーマットで記述された日時も、内部で統一的な時刻オブジェクトに変換することで、正確に比較・ソートできるようにします。

### 2.5 フィルタと検索機能

本アプリケーションは、ログを絞り込む「フィルタ機能」と、ログ内を探索する「検索機能」の 2 つを提供します。

**A. フィルタ機能**

- **目的**: 興味のあるログ行のみを表示し、それ以外を非表示にする。
- **UI**: メインウィンドウ上部のフィルタボックス。
- **仕様**: 入力されたキーワードを含む行のみを `DataGrid` に表示します。

**B. 検索機能**

- **目的**: 表示されているログ行の中から、特定の条件に合致する行を見つけ出し、フォーカスを移動する（行の非表示は行わない）。
- **トリガー**: `Ctrl+F` キー押下。
- **UI**:
  - メインウィンドウの手前に表示される、モダンでシンプルなデザインのモードレスダイアログ（検索ウィンドウ）。
  - **構成要素**:
    - 検索キーワード入力欄
    - **検索オプション**: 以下の機能をアイコンのトグルボタンで提供。
      - 大文字・小文字を区別 (Case Sensitive)
      - 正規表現を使用 (Regular Expression)
    - **ナビゲーション**: 「次を検索」「前を検索」ボタン（エンターキー等のショートカットも対応）。
- **検索対象**: `Message`, `AdditionalData` の値、 `FileName`。
- **動作**:
  - 検索条件に一致する次の（または前の）ログエントリを特定します。
  - `DataGrid` 上でその行を選択状態にし、画面内にスクロール表示します。

**C. 日時指定ジャンプ機能 (Go To Date)**

- **目的**: フィルタ（非表示）を行わずに、指定した日時の周辺のログへ素早く移動する。トラブルシューティング時に「障害発生時刻の前後」を確認するために使用する。
- **トリガー**: `Ctrl+G` キー押下。
- **UI**:
  - メインウィンドウの右上に表示される、検索ウィンドウとデザインを統一したモダンなモードレスウィンドウ。
  - **構成要素**:
    - **日付/時刻入力**: 1 行に統合された入力エリア。アイコンが入力欄の内側に配置されたインボックススタイル。
      - **カレンダー**: アイコンクリックで `DatePicker` を起動。
      - **時刻**: `Timestamp` 列の `string_format` に応じて「秒（ss）」の表示/非表示を自動的に切り替える。
    - **ジャンプ実行**: アイコンボタンをクリック、または `Enter` キー押下で指定日時にもっとも近いログへジャンプ。
    - **Shift（相対移動）セクション**:
      - **折りたたみ機能**: 左端のトグルボタン（`>` / `v`）で表示/非表示を切り替え可能。初期状態は非表示。
      - **相対移動ロジック**: 上矢印（前へ/遡る）および下矢印（次へ/進める）ボタンにより、現在表示されている日時を指定した単位（秒/分/時/日）で加減算し、そのままジャンプを実行。
  - **便利機能**:
    - ダイアログ起動時、クリップボードに日時テキストが含まれていれば自動解析してセット。
    - ウィンドウを表示したまま連続してジャンプ操作が可能。
    - `ESC` キーでウィンドウを閉じる。
- **動作**:
  - 指定された日時にもっとも近い（指定日時以降の最初の）ログエントリを特定し、選択・スクロール表示する。
  - ログ一覧は常に `Timestamp` でソートされていることを保証。

**D. ブックマーク機能 (Bookmark)**

- **目的**: 調査において重要なログ行に「しおり」を付け、視覚的に目立たせたり後で素早く参照したりできるようにする。
- **UI 構成**:
  - **専用列**: DataGrid の左端にアイコン表示用の専用列（幅 22px 固定）を配置。
- **操作**:
  - **トグル操作**:
    - ブックマーク列のセルを**ダブルクリック**。
    - 行を選択した状態で `Ctrl+B` キー押下。
  - **色分け機能**:
    - **色の種類**: 以下の 4 色から選択可能（初期値: **Blue**）。
      - Blue: `#64B5F6` (確認/情報 - 初期値)
      - Red: `#E57373` (重要/エラー)
      - Green: `#81C784` (正常/解決)
      - Yellow: `#FFF176` (警告/注意)
    - **設定方法**:
      - サイドパネル（ブックマーク一覧）上部の共有エリアにあるカラーチップをクリック。
      - ブックマーク列のアイコンを右クリックし、コンテキストメニュー「色を変更」から選択（ブックマーク済み行のみ）。
  - **ナビゲーション**:
    - `F2` キー: 次のブックマーク行へジャンプ。
    - `Shift+F2` キー: 前のブックマーク行へジャンプ。
    - 末尾/先頭に達した場合はループ。
  - **一括操作**:
    - ブックマーク列の右クリックメニュー「ブックマークをすべて解除」により、すべてのマークを解除可能。
    - 実行後も現在の選択行（フォーカス）は維持される。
  - **ブックマークフィルタ (拡張フィルター)**:
    - ブックマークされた行のみを表示するフィルタ機能。
    - **色による絞り込み**: 拡張フィルターメニューから「すべて」「赤」「青」「緑」「黄」を排他選択可能。
    - フィルタバッジには、選択された色に応じたアイコンが表示される。
- **表示**:
  - **アイコン**: 指定された色のリボンアイコンを専用列およびサイドパネルに表示。
  - **ブックマーク一覧パネル**:
    - サイドパネルに時系列で一覧表示。クリックで該当行へジャンプ。
    - メモ入力欄の横にパレットアイコンとメモアイコンを配置。
- **付加情報**:
  - **メモ機能**: 専用パネルで選択行に対して短いメモを付与可能。
- **解析支援**:
  - **ダイジェスト・ビュー**:
    - ブックマーク行を抽出し、時間差（Δt）を表示する専用画面。
    - **多重起動防止**: すでに画面が開いている場合は既存のウィンドウを前面に表示。
- **管理**:
  - **メモリ保持**: ブックマーク状態はメモリ上（アプリケーション実行中のみ）で保持される。
  - **プリセット除外**: フィルター・プリセットの保存・読み込み対象からは除外される。

### 2.6 表示列の定義と表示

**方法**

YAML 設定ファイルのトップレベルに `display_columns` を定義し、アプリケーション全体で表示する列を一元管理します。

**内容**

`display_columns`で定義された項目が、`DataGrid`の列として表示されます。

**バインディング**

`display_columns`の各項目には以下のプロパティを指定します。

- `header`: 列のヘッダー名。
- `binding_path`: `Timestamp`, `Message`, `FileName`, `LineNumber`といった固定プロパティ名や、`AdditionalData[key]`という形式で`AdditionalData`内の項目を指定します。あるログエントリに指定されたキーが存在しない場合、そのセルは空欄で表示されます。
- `width`: 列の幅。
- `string_format` (オプション): `DateTime`などの値を特定の書式で表示する場合に指定します (例: `"yyyy/MM/dd HH:mm:ss.fff"`)。

**例**

```yaml
display_columns:
  - {
      header: "Timestamp",
      binding_path: "Timestamp",
      width: 180,
      string_format: "yyyy/MM/dd HH:mm:ss.fff",
    }
  - { header: "Level", binding_path: "AdditionalData[level]", width: 80 }
  - { header: "Message", binding_path: "Message", width: 400 }
  - { header: "File", binding_path: "FileName", width: 150 }
  - { header: "Line", binding_path: "LineNumber", width: 60 }
```

### 2.7 クリップボードコピー機能

- **トリガー**: ログ行を選択した状態で `Ctrl+C` キーを押下。
- **対象**: 現在選択されているログエントリ。
- **内容**: 表示されている各列（`DisplayColumns` で定義された列）の値を、左から順にタブ文字 (`\t`) で結合したテキスト形式でクリップボードにコピーします。
- **目的**: ログの内容をテキストエディタや表計算ソフト（Excel 等）に容易に貼り付けられるようにするため。

### 2.8 ログ詳細パネル

- **目的**: 選択されたログエントリの詳細情報を、コピー可能な形式で確認できるようにする。
- **UI 構成**:
  - メインウィンドウの右側に配置される垂直パネル。
  - **開閉機能**: 境界線上のボタン（▶ で閉じる、◀ で開く）をクリックすることでパネルの表示/非表示を切り替え可能。
  - **リサイズ機能**: 境界線（中央に「||」アイコンを表示）をドラッグすることでパネル幅を調整可能。
- **表示内容**:
  - **ファイルパス**: ログが発生したファイルのフルパス。
  - **行番号**: ファイル内での行番号。
  - **ログ**: パース前のログ全文。
- **操作性**:
  - 表示されるテキストはすべてマウスでの範囲選択およびコピーが可能。
  - モダンでシンプルなデザインを採用。

### 2.9 複数行ログのサポート

- **抽出仕様**:
  - 各ログフォーマット設定に `is_multiline` オプションを追加（デフォルト: `true`）。
  - `is_multiline` が `true` の場合、**そのファイルに適用されるいずれかのフォーマット定義の `pattern` にマッチする行**を「ログの開始」と定義します。
  - いずれの `pattern` にもマッチしない行が続く場合、それらは直前のログエントリの `Message` および `RawLine` に結合されます（OS 標準の改行コードを使用）。
- **表示仕様**:
  - **DataGrid (一覧)**:
    - `Message` プロパティには全文を保持しますが、一覧上では視認性のため 1 行目のみを表示します。
    - 複数行にわたるログの場合は、メッセージの横に「複数行アイコン」を表示して視覚的に区別します。
  - **詳細パネル**: 結合されたすべての行（全文）を表示します。改行もそのまま再現され、コピー可能です。

### 2.10 拡張フィルター

- **概要**: ログの属性に基づいた複数の高度な絞り込み機能の総称。
- **構成**:
  - **A. カラムフィルター**:
    - 指定した項目（`AdditionalData`）が空である行を非表示にする。
    - 複数の項目を選択した場合、それらすべてが空である行を非表示にする（AND 条件）。
  - **B. 日時フィルター**:
    - 選択した行の日時を基準に、それ以前または以降のログのみを表示する。
    - 「以降」および「以前」の条件はそれぞれ 1 つずつのみ保持可能（新しい条件で上書き）。
- **操作インターフェース**:
  - **フィルターバッジ**: フィルターボックスの下に有効なフィルターを表示。
    - フィルターが設定されていない場合は領域自体を非表示にし、画面を広く活用する。
    - フィルターが増えた場合は自動的に複数行に折り返して表示される。
    - カラムフィルター例: `[x] Level`
    - 日時フィルター例: `[x] 2025/12/20 21:49:53以降` (表示形式は列設定に従う)
  - **右クリックメニュー**:
    - **AdditionalData のセル/ヘッダー**: 「拡張フィルターに追加」を表示。
    - **Timestamp のセル**: 「以降をフィルターに追加」「以前をフィルターに追加」を表示。
  - **フィルターアイコン（漏斗）**: クリックすることで、カラムフィルター用の項目リストをメニュー表示し、追加が可能。
- **動的更新**: ログファイル読み込み時に利用可能な項目を自動抽出。

### 2.11 表示データの変換機能 (Field Transformation)

- **目的**: 正規表現で抽出した特定の項目に対し、置換や整形を施して表示を最適化する。
- **設定方法**:
  - `log_formats` または `sub_patterns` リスト内に `field_transforms` を定義。
  - 対象とする正規表現のグループ名（`field`）を指定。
- **変換ルール**:
  - **マッピング (`map`)**: 特定の文字列を別の文字列に完全一致で置換する（例: "E" -> "ERROR"）。
  - **フォーマット (`format`)**: 抽出された文字列（マッピング後）を指定した書式に埋め込む（例: "処理開始:{value}"）。
  - **適用タイミング**:
  - 各正規表現によるパース直後、値を `LogEntry` や `AdditionalData` に格納する前に適用される。

### 2.12 Tail 機能 (リアルタイム監視)

- **概要**: ログファイルの更新を監視し、新規追加行をリアルタイムに表示する機能。
- **操作インターフェース**:
  - **Tail ボタン**: 狼の尻尾をイメージしたアイコン。クリックで ON/OFF を切り替え。
- **動作仕様**:
  - **監視方式**: 指定された `polling_interval_ms`（デフォルト 1000ms）ごとにファイルサイズを確認し、増加分のみを読み込む。
  - **自動スクロール**:
    - 機能 ON かつ、現在 `DataGrid` の最下部を表示している場合、新しいログが追加されると自動的に最下部へスクロールする。
    - ユーザーが手動でスクロールし、最下部以外の場所を見ている場合は、自動スクロールを停止して現在の表示行を維持する。
- **設定**:
  - `polling_interval_ms`: 監視の更新間隔（ミリ秒）。

### 2.13 カラムごとのスタイル定義 (ハイライト & セマンティック・カラーリング)

- **目的**: ログの視認性を高めるため、特定の値を持つセルや、特定の種類（ユーザー名など）のデータを持つセルに色を付ける。
- **設定方法**:
  - YAML 設定ファイルのトップレベルに `column_styles` を定義。
  - `column_header` で対象のカラム（`display_columns` で定義したヘッダー名）を指定。
- **機能**:
  - **A. ルールベースの色付け (`rules`)**:
    - **条件**: `pattern` (正規表現) に一致するかどうか。
    - **適用**: `foreground` (文字色), `background` (背景色), `font_weight` (太字など) を指定可能。
    - **優先順位**: リストの上から順に評価し、最初にマッチしたルールを適用する。
  - **B. セマンティック・カラーリング (`semantic_coloring`)**:
    - **条件**: `semantic_coloring: true` を指定。
    - **適用**: セルの値（文字列）に基づいて一意のパステルカラーを自動生成し、背景色として適用する。文字色は背景色の輝度に基づき自動で黒または白に決定される。
    - **優先順位**: `rules` にマッチしなかった場合、または `rules` が定義されていない場合に適用される。

**例**

```yaml
column_styles:
  - column_header: "Level"
    rules:
      - pattern: "^(ERROR|FATAL)$"
        foreground: "White"
        background: "#D32F2F"
        font_weight: "Bold"
      - pattern: "^WARN"
        background: "#FFC107"
        foreground: "Black"
  - column_header: "User"
    semantic_coloring: true
```

### 2.14 フィルタ・プリセット (保存と読み込み)

- **目的**: 複雑な絞り込み条件（キーワード + 拡張フィルター）をファイルとして保存し、あとで再利用できるようにする。
- **保存内容**:
  - `FilterText` (検索キーワード)
  - `ActiveExtensionFilters` のリスト
- **操作インターフェース**:
  - フィルターアイコン（漏斗）の右クリックメニューに以下の項目を追加。
    - **フィルターを保存...**: 現在の条件を YAML ファイルとして保存。
    - **フィルターを読み込む...**: 保存済みの YAML ファイルを選択して適用。
- **ファイル管理**:
  - `config.yaml` とは別の独立した YAML ファイルとして管理し、解析目的ごとに使い分けを可能にする。

## 3. 技術スタック

- **言語**: C# 8.0
- **フレームワーク**: WPF
- **アーキテクチャパターン**: MVVM (クリーンアーキテクチャ原則に準拠)
- **設定ファイル形式**: YAML

## 4. 開発方針

- TDD (テスト駆動開発) およびベイビーステップ戦略を採用し、段階的に機能実装を進めます。
