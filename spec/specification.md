# MultiLogViewer アプリケーション仕様書

## 1. 目的

複数の異なる形式のログファイルを一元的に読み込み、統一されたビューで閲覧・分析することを目的とします。

## 2. 主要機能

### 2.1 設定ファイル

**パスの解決**

アプリケーションは、以下の優先順位で設定ファイル `config.yaml` を検索します。

1. **コマンドライン引数**: アプリケーション起動時にコマンドライン引数として渡されたファイルパスを最優先で使用します。
   - 例: `MultiLogViewer.exe "C:\path\to\my_config.yaml"`
2. **デフォルトパス**: コマンドライン引数が指定されていない場合、アプリケーションの実行ファイル（`.exe`）と同じディレクトリにある `config.yaml` を使用します。

### 2.2 ログフォーマット設定

**方法**

YAML 形式の設定ファイルを用いて、ログファイルのフォーマットと対象ファイルを定義します。

**内容**

- **対象ファイル**: `log_file_patterns` に、このフォーマットを適用するログファイルの glob パターンをリスト形式で指定します。
- **パースルール**:
  - ログ 1 行全体に適用するプライマリな正規表現（`pattern`）を定義します。
  - 抽出する項目には名前を付け（例: `timestamp`, `level`, `message`）、`LogEntry`オブジェクトに格納します。
    - `timestamp`と`message`は基本的な項目として扱われますが、それ以外（`level`を含む）は`AdditionalData`に格納されます。
  - 特定のフィールド（例: `message`）の内容をさらにパースするため、追加の正規表現（`sub_patterns`）を定義できます。

**例**

```yaml
log_formats:
  - name: "ApplicationLog"
    log_file_patterns:
      - "C:\\Logs\\App\\*.log"
      - "C:\\Logs\\Old\\app-*.log"
    pattern: "^(?<timestamp>\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}) \\\\[(?<level>\\w+)\\] (?<message>.*)$"
    timestamp_format: "yyyy-MM-dd HH:mm:ss"
    sub_patterns:
      - source_field: "message"
        pattern: "User '(?<user>\\w+)' from (?<ip>[\\d\\.]+)"
```

### 2.3 ログの読み込みとパース

**読み込みトリガー**

アプリケーション起動時に、設定ファイルに基づきログの読み込みを自動的に開始します。手動でのファイル選択機能は廃止します。

**処理フロー**

1. 各`log_format`定義内の`log_file_patterns`（glob パターン）を`FileResolver`サービスが解決し、一致するすべてのログファイルパスのリストを取得します。
2. 該当するログファイルを、対応する`pattern`と`sub_patterns`を用いて一行ずつパースし、構造化されたデータ（ログエントリ）に変換します。
3. `LogFileReader`は、各ログエントリがどのファイルの何行目から読み込まれたかという情報も付与します。
4. すべてのフォーマット・ファイルから集約したログエントリをビューに表示します。

**LogEntry オブジェクトの構造**

各ログエントリは、以下の情報を持つオブジェクトとして表現されます。

- `Timestamp` (DateTime): ログのタイムスタンプ
- `Message` (string): ログメッセージ
- `FileName` (string): ログの発生元ファイル名
- `LineNumber` (int): ログの発生元ファイルにおける行番号
- `AdditionalData` (Dictionary<string, string>): `level`など、正規表現で抽出されたその他のデータ

### 2.4 時刻によるソート

- パースされたログエントリは、日時情報に基づいて昇順または降順でソートされます。
- 異なるフォーマットで記述された日時も、内部で統一的な時刻オブジェクトに変換することで、正確に比較・ソートできるようにします。

### 2.5 フィルタと検索機能

本アプリケーションは、ログを絞り込む「フィルタ機能」と、ログ内を探索する「検索機能」の 2 つを提供します。

**A. フィルタ機能**

- **目的**: 興味のあるログ行のみを表示し、それ以外を非表示にする。
- **UI**: メインウィンドウ上部のフィルタボックス。
- **仕様**: 入力されたキーワードを含む行のみを `DataGrid` に表示します。

**B. 検索機能**

- **目的**: 表示されているログ行の中から、特定の条件に合致する行を見つけ出し、フォーカスを移動する（行の非表示は行わない）。
- **トリガー**: `Ctrl+F` キー押下。
- **UI**:
  - メインウィンドウの手前に表示される、モダンでシンプルなデザインのモードレスダイアログ（検索ウィンドウ）。
  - **構成要素**:
    - 検索キーワード入力欄
    - **検索オプション**: 以下の機能をアイコンのトグルボタンで提供。
      - 大文字・小文字を区別 (Case Sensitive)
      - 正規表現を使用 (Regular Expression)
    - **ナビゲーション**: 「次を検索」「前を検索」ボタン（エンターキー等のショートカットも対応）。
- **検索対象**: `Message`, `AdditionalData` の値、 `FileName`。
- **動作**:
  - 検索条件に一致する次の（または前の）ログエントリを特定します。
  - `DataGrid` 上でその行を選択状態にし、画面内にスクロール表示します。

### 2.6 表示列の定義と表示

**方法**

YAML 設定ファイルのトップレベルに `display_columns` を定義し、アプリケーション全体で表示する列を一元管理します。

**内容**

`display_columns`で定義された項目が、`DataGrid`の列として表示されます。

**バインディング**

`display_columns`の各項目には以下のプロパティを指定します。

- `header`: 列のヘッダー名。
- `binding_path`: `Timestamp`, `Message`, `FileName`, `LineNumber`といった固定プロパティ名や、`AdditionalData[key]`という形式で`AdditionalData`内の項目を指定します。あるログエントリに指定されたキーが存在しない場合、そのセルは空欄で表示されます。
- `width`: 列の幅。
- `string_format` (オプション): `DateTime`などの値を特定の書式で表示する場合に指定します (例: `"yyyy/MM/dd HH:mm:ss.fff"`)。

**例**

```yaml
display_columns:
  - {
      header: "Timestamp",
      binding_path: "Timestamp",
      width: 180,
      string_format: "yyyy/MM/dd HH:mm:ss.fff",
    }
  - { header: "Level", binding_path: "AdditionalData[level]", width: 80 }
  - { header: "Message", binding_path: "Message", width: 400 }
  - { header: "File", binding_path: "FileName", width: 150 }
  - { header: "Line", binding_path: "LineNumber", width: 60 }
```

### 2.7 クリップボードコピー機能

- **トリガー**: ログ行を選択した状態で `Ctrl+C` キーを押下。
- **対象**: 現在選択されているログエントリ。
- **内容**: 表示されている各列（`DisplayColumns` で定義された列）の値を、左から順にタブ文字 (`\t`) で結合したテキスト形式でクリップボードにコピーします。
- **目的**: ログの内容をテキストエディタや表計算ソフト（Excel 等）に容易に貼り付けられるようにするため。

### 2.8 ログ詳細パネル

- **目的**: 選択されたログエントリの詳細情報を、コピー可能な形式で確認できるようにする。
- **UI 構成**:
  - メインウィンドウの右側に配置される垂直パネル。
  - **開閉機能**: 境界線上のボタン（▶ で閉じる、◀ で開く）をクリックすることでパネルの表示/非表示を切り替え可能。
  - **リサイズ機能**: 境界線（中央に「||」アイコンを表示）をドラッグすることでパネル幅を調整可能。
- **表示内容**:
  - **ファイルパス**: ログが発生したファイルのフルパス。
  - **行番号**: ファイル内での行番号。
  - **ログ**: パース前のログ全文。
- **操作性**:
  - 表示されるテキストはすべてマウスでの範囲選択およびコピーが可能。
  - モダンでシンプルなデザインを採用。

### 2.9 複数行ログのサポート

- **抽出仕様**:
  - 各ログフォーマット設定に `is_multiline` オプションを追加（デフォルト: `true`）。
  - `is_multiline` が `true` の場合、設定ファイルの `pattern` にマッチする行を「ログの開始」と定義します。
  - `pattern` にマッチしない行が続く場合、それらは直前のログエントリの `Message` および `RawLine` に結合されます（OS 標準の改行コードを使用）。
- **表示仕様**:
  - **DataGrid (一覧)**:
    - `Message` プロパティには全文を保持しますが、一覧上では視認性のため 1 行目のみを表示します。
    - 複数行にわたるログの場合は、メッセージの横に「複数行アイコン」を表示して視覚的に区別します。
  - **詳細パネル**: 結合されたすべての行（全文）を表示します。改行もそのまま再現され、コピー可能です。

### 2.10 拡張フィルター

- **概要**: ログの属性に基づいた複数の高度な絞り込み機能の総称。
- **構成**:
  - **A. カラムフィルター**:
    - 指定した項目（`AdditionalData`）が空である行を非表示にする。
    - 複数の項目を選択した場合、それらすべてが空である行を非表示にする（AND 条件）。
  - **B. 日時フィルター**:
    - 選択した行の日時を基準に、それ以前または以降のログのみを表示する。
    - 「以降」および「以前」の条件はそれぞれ 1 つずつのみ保持可能（新しい条件で上書き）。
- **操作インターフェース**:
  - **フィルターバッジ**: フィルターボックスの下に有効なフィルターを表示。
    - フィルターが設定されていない場合は領域自体を非表示にし、画面を広く活用する。
    - フィルターが増えた場合は自動的に複数行に折り返して表示される。
    - カラムフィルター例: `[x] Level`
    - 日時フィルター例: `[x] 2025/12/20 21:49:53以降` (表示形式は列設定に従う)
  - **右クリックメニュー**:
    - **AdditionalData のセル/ヘッダー**: 「拡張フィルターに追加」を表示。
    - **Timestamp のセル**: 「以降をフィルターに追加」「以前をフィルターに追加」を表示。
  - **フィルターアイコン（漏斗）**: クリックすることで、カラムフィルター用の項目リストをメニュー表示し、追加が可能。
- **動的更新**: ログファイル読み込み時に利用可能な項目を自動抽出。

### 2.11 表示データの変換機能 (Field Transformation) (新規追加)

- **目的**: 正規表現で抽出した特定の項目に対し、置換や整形を施して表示を最適化する。
- **設定方法**:
  - `log_formats` または `sub_patterns` リスト内に `field_transforms` を定義。
  - 対象とする正規表現のグループ名（`field`）を指定。
- **変換ルール**:
  - **マッピング (`map`)**: 特定の文字列を別の文字列に完全一致で置換する（例: "E" -> "ERROR"）。
  - **フォーマット (`format`)**: 抽出された文字列（マッピング後）を指定した書式に埋め込む（例: "処理開始:{value}"）。
  - **適用タイミング**:
  - 各正規表現によるパース直後、値を `LogEntry` や `AdditionalData` に格納する前に適用される。

### 2.12 Tail 機能 (リアルタイム監視) (新規追加)

- **概要**: ログファイルの更新を監視し、新規追加行をリアルタイムに表示する機能。
- **操作インターフェース**:
  - **Tail ボタン**: 狼の尻尾をイメージしたアイコン。クリックで ON/OFF を切り替え。
- **動作仕様**:
  - **監視方式**: 指定された `polling_interval_ms`（デフォルト 1000ms）ごとにファイルサイズを確認し、増加分のみを読み込む。
  - **自動スクロール**:
    - 機能 ON かつ、現在 `DataGrid` の最下部を表示している場合、新しいログが追加されると自動的に最下部へスクロールする。
    - ユーザーが手動でスクロールし、最下部以外の場所を見ている場合は、自動スクロールを停止して現在の表示行を維持する。
- **設定**:
  - `polling_interval_ms`: 監視の更新間隔（ミリ秒）。

## 3. 技術スタック
- **言語**: C# 8.0
- **フレームワーク**: WPF
- **アーキテクチャパターン**: MVVM (クリーンアーキテクチャ原則に準拠)
- **設定ファイル形式**: YAML

## 4. 開発方針

- TDD (テスト駆動開発) およびベイビーステップ戦略を採用し、段階的に機能実装を進めます。
